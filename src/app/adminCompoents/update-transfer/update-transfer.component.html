<div class="form-wrapper">
  <form [formGroup]="transferForm" (ngSubmit)="onSubmit()" class="create-transfer-form">
    <h2 class="mb-4 text-center">Update Transfer</h2>

    <!-- ========================= -->
    <!-- Reference Name -->
    <!-- ========================= -->
    <div class="form-group mb-3">
      <label class="form-label">Reference Name <span class="text-danger">*</span></label>
      <input 
        type="text" 
        class="form-control" 
        formControlName="referenceName"
        placeholder="Enter reference name"
        [ngClass]="{'is-invalid': transferForm.get('referenceName')?.invalid && transferForm.get('referenceName')?.touched}"
      />
      <div class="invalid-feedback" *ngIf="transferForm.get('referenceName')?.invalid && transferForm.get('referenceName')?.touched">
        Reference name is required
      </div>
    </div>

    <!-- ========================= -->
    <!-- Destination -->
    <!-- ========================= -->
    <div class="col-md-6 mb-3">
      <label class="form-label">Destination <span class="text-danger">*</span></label>
      <input
        type="text"
        class="form-control"
        value="Hurghada"
        readonly
      />
      <input
        type="hidden"
        formControlName="fkDestinationId"
      />
      <div class="invalid-feedback" *ngIf="transferForm.get('fkDestinationId')?.invalid && transferForm.get('fkDestinationId')?.touched">
        Destination is required
      </div>
    </div>

    <!-- ========================= -->
    <!-- Active Checkbox -->
    <!-- ========================= -->
    <div class="form-group mb-3">
      <div class="form-check">
        <input 
          type="checkbox" 
          class="form-check-input" 
          formControlName="isActive"
          id="isActive"
        />
        <label class="form-check-label" for="isActive">Active</label>
      </div>
    </div>

    <!-- ========================= -->
    <!-- Upload Image -->
    <!-- ========================= -->
    <div class="mb-4">
      <label class="form-label">Main Image</label>
      <input 
        type="file" 
        #fileInput 
        (change)="onFileSelected($event)" 
        class="form-control"
        accept="image/*"
      />
      
      <div class="image-preview mt-2" *ngIf="imagePreview">
        <img [src]="imagePreview" alt="Preview" class="img-thumbnail" style="max-height: 200px;" />
        <button 
          type="button" 
          class="btn btn-sm btn-danger mt-2" 
          (click)="removeImage()"
        >
          Remove New Image
        </button>
      </div>
      
      <div *ngIf="existingImage && !imagePreview" class="mt-2">
        <p class="text-muted">Current Image:</p>
        <img [src]="existingImage" class="img-thumbnail" style="max-height: 200px;" />
      </div>
    </div>

    <!-- ========================= -->
    <!-- Language Tabs -->
    <!-- ========================= -->
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item" *ngFor="let lang of languages; let i = index">
        <button
          type="button"
          class="nav-link"
          [class.active]="i === 0"
          data-bs-toggle="tab"
          [attr.data-bs-target]="'#tab-' + lang"
        >
          {{ lang.toUpperCase() }}
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <div 
        class="tab-pane fade" 
        [class.show]="i === 0" 
        [class.active]="i === 0" 
        *ngFor="let lang of languages; let i = index" 
        [attr.id]="'tab-' + lang"
      >
        <!-- ========================= -->
        <!-- Translations -->
        <!-- ========================= -->
        <div [formGroup]="getTranslationGroup(lang)" class="mb-3">
          <h6>Translations</h6>
          <div class="mb-2">
            <label class="form-label">Name <span class="text-danger">*</span></label>
            <input 
              type="text" 
              class="form-control" 
              formControlName="name"
              placeholder="Name"
              [ngClass]="{'is-invalid': getTranslationGroup(lang).get('name')?.invalid && getTranslationGroup(lang).get('name')?.touched}"
            />
            <div class="invalid-feedback" *ngIf="getTranslationGroup(lang).get('name')?.invalid && getTranslationGroup(lang).get('name')?.touched">
              Name is required
            </div>
          </div>
          
          <div class="mb-2">
            <label class="form-label">Description <span class="text-danger">*</span></label>
            <textarea 
              class="form-control" 
              formControlName="description"
              placeholder="Description"
              rows="3"
              [ngClass]="{'is-invalid': getTranslationGroup(lang).get('description')?.invalid && getTranslationGroup(lang).get('description')?.touched}"
            ></textarea>
            <div class="invalid-feedback" *ngIf="getTranslationGroup(lang).get('description')?.invalid && getTranslationGroup(lang).get('description')?.touched">
              Description is required
            </div>
          </div>
          
          <div class="mb-2">
            <label class="form-label">Meta Description</label>
            <textarea 
              class="form-control" 
              formControlName="metaDescription"
              placeholder="Meta Description"
              rows="2"
            ></textarea>
          </div>
          
          <div class="mb-2">
            <label class="form-label">Meta Keywords</label>
            <textarea 
              class="form-control" 
              formControlName="metaKeyWords"
              placeholder="Meta Keywords"
              rows="2"
            ></textarea>
          </div>
        </div>

        <!-- ========================= -->
        <!-- Prices -->
        <!-- ========================= -->
        <div formGroupName="prices" class="mb-3">
          <h6>Prices</h6>
          <div [formArrayName]="lang">
            <div *ngFor="let p of getPrices(lang).controls; let j = index" [formGroupName]="j" class="d-flex gap-2 mb-2 align-items-center">
              <input 
                class="form-control" 
                formControlName="title" 
                placeholder="Title"
                [ngClass]="{'is-invalid': p.get('title')?.invalid && p.get('title')?.touched}"
              />
              <input 
                type="number" 
                class="form-control" 
                formControlName="privtePrice" 
                placeholder="Private Price"
                [ngClass]="{'is-invalid': p.get('privtePrice')?.invalid && p.get('privtePrice')?.touched}"
              />
              <input 
                type="number" 
                class="form-control" 
                formControlName="sharedPrice" 
                placeholder="Shared Price"
                [ngClass]="{'is-invalid': p.get('sharedPrice')?.invalid && p.get('sharedPrice')?.touched}"
              />
              <button 
                type="button" 
                class="btn btn-danger btn-sm" 
                (click)="removePrice(lang, j)"
              >
                X
              </button>
            </div>
          </div>
          <button 
            type="button" 
            class="btn btn-secondary btn-sm mt-1" 
            (click)="addPrice(lang)"
          >
            + Add Price
          </button>
        </div>

        <!-- ========================= -->
        <!-- Includes -->
        <!-- ========================= -->
        <div formGroupName="includes" class="mb-3">
          <h6>Includes</h6>
          <div [formArrayName]="lang">
            <div *ngFor="let inc of getIncludes(lang).controls; let j = index" [formGroupName]="j" class="d-flex gap-2 mb-2 align-items-center">
              <input 
                class="form-control" 
                formControlName="text" 
                placeholder="Include"
                [ngClass]="{'is-invalid': inc.get('text')?.invalid && inc.get('text')?.touched}"
              />
              <button 
                type="button" 
                class="btn btn-danger btn-sm" 
                (click)="removeInclude(lang, j)"
              >
                X
              </button>
            </div>
          </div>
          <button 
            type="button" 
            class="btn btn-secondary btn-sm mt-1" 
            (click)="addInclude(lang)"
          >
            + Add Include
          </button>
        </div>

        <!-- ========================= -->
        <!-- Not Includes -->
        <!-- ========================= -->
        <div formGroupName="notIncludes" class="mb-3">
          <h6>Not Included</h6>
          <div [formArrayName]="lang">
            <div *ngFor="let ni of getNotIncludes(lang).controls; let j = index" [formGroupName]="j" class="d-flex gap-2 mb-2 align-items-center">
              <input 
                class="form-control" 
                formControlName="text" 
                placeholder="Not Included"
                [ngClass]="{'is-invalid': ni.get('text')?.invalid && ni.get('text')?.touched}"
              />
              <button 
                type="button" 
                class="btn btn-danger btn-sm" 
                (click)="removeNotInclude(lang, j)"
              >
                X
              </button>
            </div>
          </div>
          <button 
            type="button" 
            class="btn btn-secondary btn-sm mt-1" 
            (click)="addNotInclude(lang)"
          >
            + Add Not Included
          </button>
        </div>

        <!-- ========================= -->
        <!-- Highlights -->
        <!-- ========================= -->
        <div formGroupName="highlights" class="mb-3">
          <h6>Highlights</h6>
          <div [formArrayName]="lang">
            <div *ngFor="let h of getHighlights(lang).controls; let j = index" [formGroupName]="j" class="d-flex gap-2 mb-2 align-items-center">
              <input 
                class="form-control" 
                formControlName="text" 
                placeholder="Highlight"
                [ngClass]="{'is-invalid': h.get('text')?.invalid && h.get('text')?.touched}"
              />
              <button 
                type="button" 
                class="btn btn-danger btn-sm" 
                (click)="removeHighlight(lang, j)"
              >
                X
              </button>
            </div>
          </div>
          <button 
            type="button" 
            class="btn btn-secondary btn-sm mt-1" 
            (click)="addHighlight(lang)"
          >
            + Add Highlight
          </button>
        </div>
      </div>
    </div>

    <!-- ========================= -->
    <!-- Submit Button -->
    <!-- ========================= -->
    <button 
      type="submit" 
      class="btn btn-primary w-100 py-2 mt-3" 
      [disabled]="isSubmitting"
    >
      <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
      {{ isSubmitting ? 'Updating...' : 'Update Transfer' }}
    </button>
  </form>

  <!-- ========================= -->
  <!-- Error Summary -->
  <!-- ========================= -->
  <div *ngIf="formErrors.length" class="alert alert-danger mt-3">
    <h6 class="alert-heading">Please fix the following errors:</h6>
    <ul class="mb-0">
      <li *ngFor="let e of formErrors">
        <strong>{{ e.label }}</strong> <span *ngIf="e.lang">({{ e.lang.toUpperCase() }})</span> is required
      </li>
    </ul>
  </div>
</div>